networks:
  internal:
    internal: true
  external: {}

services:
  squid:
    build:
      context: .
      dockerfile: Dockerfile.squid
    networks:
      - internal
      - external
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "squidclient", "-h", "127.0.0.1", "-p", "3128", "mgr:info"]
      interval: 5s
      timeout: 3s
      retries: 5

  framework:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      squid:
        condition: service_healthy
    networks:
      - internal
    read_only: true
    tmpfs:
      - /tmp:size=1g
      - /var/tmp:size=512m
      - /root/.local/bin:size=1m
      - /root/.local/share:size=1m
      - /root/.npm:size=512m
      - /root/.config:size=256m
      - /root/.cache:size=256m
    stdin_open: true
    tty: true
    environment:
      - HTTP_PROXY=http://squid:3128
      - HTTPS_PROXY=http://squid:3128
      - NO_PROXY=localhost,127.0.0.1,squid
      - IMAP_HOST=squid
      - IMAP_PORT=1993
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - ASANA_ACCESS_TOKEN=${ASANA_ACCESS_TOKEN:-}
      - TRELLO_API_KEY=${TRELLO_API_KEY:-}
      - TRELLO_TOKEN=${TRELLO_TOKEN:-}
      - DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=1
      - OBSIDIAN_MCP_BRIDGE_URL=${OBSIDIAN_MCP_BRIDGE_URL:-http://squid:8787/sse}
    volumes:
      - ${CC_GTD_PATH:-..}:/workspace/cc-gtd
      - ${SYSTEMS_PATH:-../systems}:/workspace/cc-gtd/systems
      - ${GCALCLI_OAUTH_DIR:-~/.gcalcli}:/credentials/gcalcli:ro
      - ~/.claude:/root/.claude
      - ./container-settings.json:/root/.claude/settings.json:ro
      - ./claude-bin:/opt/claude:ro
      - ./trello-cli-bin:/opt/trello-cli:ro
      - ./entrypoint.sh:/entrypoint.sh:ro
    working_dir: /workspace/cc-gtd
